---
- name: install fastd dependencies
  apt: pkg={{ item }} state=present
  with_items:
  - iproute2
  - batctl
  - fastd

- name: create blacklist_fastd script directory
  file:
    path: /opt/freifunk/server-scripts/
    state: directory
    owner: root

- name: install blacklist_fastd script
  copy:
    src: blacklist_fastd.py
    dest: /opt/freifunk/server-scripts/blacklist_fastd.py
    group: root
    owner: root
    mode: 0755

- name: create fastd instance directories
  file:
    state: directory
    path: /etc/fastd/{{ item }}/
  with_items: "{{ ffv_domains }}"

- name: install fastd config
  template:
    src: fastd.conf.j2
    dest: /etc/fastd/{{ item }}/fastd.conf
  with_items: "{{ ffv_domains }}"
  notify:
  - restart fastd

- name: disable sysv initscript
  systemd:
    name: fastd.service
    daemon_reload: yes
    enabled: no
    state: stopped

- name: create batadv-bat-X override directory
  file:
    dest: /etc/systemd/system/fastd@.service.d
    state: directory

- name: enabled batadv-bat-X dependency for fastd
  template:
    src: override.conf.j2
    dest: /etc/systemd/system/fastd@.service.d/override.conf
  notify:
  - restart fastd

- name: start fastd
  systemd:
    name: "fastd@{{ item }}.service"
    daemon_reload: yes
    enabled: yes
    state: started
  with_items: "{{ ffv_domains }}"

- name: install fastd_slow_balancer dependencies
  apt: pkg={{ item }} state=present
  with_items:
  - curl
  - python3

- name: create fastd_slow_balancer script directory
  file:
    path: /opt/freifunk/server-scripts/
    state: directory
    owner: root

- name: install fastd_slow_balancer scripts
  copy:
    src: fastd_slow_balancer.py
    dest: /opt/freifunk/server-scripts/fastd_slow_balancer.py
    group: root
    owner: root
    mode: 0755
  notify:
  - restart fastd_slow_balancer

- name: install fastd_slow_balancer scripts
  template:
    src: fastd_slow_balancer_check.sh
    dest: /opt/freifunk/server-scripts/fastd_slow_balancer_check.sh
    group: root
    owner: root
    mode: 0755

- name: install fastd_slow_balancer config
  template:
    src: fastd_slow_balancer.json.j2
    dest: /etc/fastd_slow_balancer.json
  notify:
  - restart fastd_slow_balancer

- name: install fastd_slow_balancer service
  copy:
    src: fastd_slow_balancer.service
    dest: /etc/systemd/system/fastd_slow_balancer.service
  notify:
  - restart fastd_slow_balancer

- name: start fastd_slow_balancer
  systemd:
    name: fastd_slow_balancer.service
    daemon_reload: yes
    enabled: yes
    state: started
