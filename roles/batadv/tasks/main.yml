---
- name: install batman-adv dependencies
  apt: pkg={{ item }} state=installed
  with_items:
  - build-essential
  - git
  - dkms
  - linux-headers-amd64

- name: install batman-adv sources
  git:
    repo: 'https://github.com/FreifunkVogtland/batman-adv.git'
    dest: /usr/src/batman-adv-{{ batadv_version }}
    version: v{{ batadv_version }}

- name: install batadv dkms config
  template:
    src: dkms.conf.j2
    dest: /usr/src/batman-adv-{{ batadv_version }}/dkms.conf

- name: check for added batman-adv dkms
  stat:
    path: /var/lib/dkms/batman-adv/{{ batadv_version }}/source
  register: batadv_dkms_added

- name: register batman-adv dkms sources
  command: dkms add -m batman-adv -v {{ batadv_version }}
  when: batadv_dkms_added.stat.islnk is not defined

# TODO check whether it is already installed and not whether source link exists
- name: build batman-adv dkms sources
  command: dkms autoinstall -m batman-adv -v {{ batadv_version }}
  when: batadv_dkms_added.stat.islnk is not defined

- name: install dummy-bat0
  template:
    src: dummy-bat0.netdev.j2
    dest: /etc/systemd/network/25-dummy-bat0.netdev
  notify:
  - restart networkd

- name: install bat0 link
  template:
    src: bat0.link.j2
    dest: /etc/systemd/network/25-bat0.link
  notify:
  - restart networkd

- name: install bat0 network
  template:
    src: bat0.network.j2
    dest: /etc/systemd/network/25-bat0.network
  notify:
  - restart networkd

- name: start systemd-networkd
  systemd:
    name: systemd-networkd.service
    daemon_reload: yes
    enabled: yes
    state: started

- name: install batadv-bat0
  template:
    src: batadv-bat0.service.j2
    dest: /etc/systemd/system/batadv-bat0.service
  notify:
  - restart batadv-bat0

- name: start batadv-bat0
  systemd:
    name: batadv-bat0.service
    daemon_reload: yes
    enabled: yes
    state: started
