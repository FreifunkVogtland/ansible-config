[Unit]
Description=vxlan0 setup
Wants=network.target
BindsTo=batadv-bat0.service
After=batadv-bat0.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/ip link add vxlan0 type vxlan id "{{vlan_id}}" dev "{{gateway_if}}" dstport 4789 nolearning
ExecStart=/bin/ip link set dev vxlan0 address {{ '02:47:89:00:%02x:00'|format(vpnid|int) }}
ExecStart=/bin/ip link set mtu 1426 up dev vxlan0

{% for peer in (groups['vpns'] | difference([inventory_hostname])) %}
{% if hostvars[peer]['WANIP'] is defined %}
ExecStart=/sbin/bridge fdb append to 00:00:00:00:00:00 dst {{ hostvars[peer]['WANIP'] }} dev vxlan0
ExecStart=/sbin/bridge fdb append to {{ '02:47:89:00:%02x:00'|format(hostvars[peer]['vpnid']|int) }} dst {{ hostvars[peer]['WANIP'] }} dev vxlan0
{% endif %}
{% endfor %}
ExecStart=/sbin/bridge fdb append to {{ '02:47:89:00:%02x:00'|format(vpnid|int) }} dst 127.0.0.1 dev vxlan0

ExecStart=/bin/ip link set dev "vxlan0" master bat0
ExecStart=/bin/sh -c 'echo 1 > /sys/class/net/vxlan0/batman_adv/no_rebroadcast'

ExecStop=/bin/ip link del dev "vxlan0"

[Install]
WantedBy=multi-user.target
WantedBy=respondd.service
