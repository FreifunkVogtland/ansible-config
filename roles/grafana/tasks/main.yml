---
- name: add apt https support
  apt: pkg={{ item }} state=present
  with_items:
  - apt-transport-https

- name: enable grafana apt key
  apt_key:
    data: "{{ lookup('file', 'grafana.asc') }}"
    state: present 
    keyring: /etc/apt/trusted.gpg.d/grafana.gpg

- name: add grafana apt sources
  copy:
    src: grafana.list
    dest: /etc/apt/sources.list.d/grafana.list
  notify: update apt-cache

- name: add grafana apt preferences
  copy:
    src: grafana.pref
    dest: /etc/apt/preferences.d/grafana.pref
  notify: update apt-cache

- meta: flush_handlers

- name: install grafana dependencies
  apt: pkg={{ item }} state=present
  with_items:
  - apache2
  - grafana
  - libapache2-mod-wsgi
  - influxdb
  - sqlite3

# TODO update influxdb to 1.5.3-2
# TODO sudo a2enmod rewrite

- name: add grafana dashboard provisioning configuration
  copy:
    src: ffv.yaml
    dest: /etc/grafana/provisioning/dashboards/ffv.yaml
    owner: root
    group: grafana
    mode: 0640
  notify: restart grafana-server

- name: add grafana configuration
  copy:
    src: grafana.ini
    dest: /etc/grafana/grafana.ini
    owner: root
    group: grafana
    mode: 0640
  notify: restart grafana-server

- name: add influxdb config
  copy:
    src: influxdb.conf
    dest: /etc/influxdb/influxdb.conf
  notify:
  - restart influxdb

- name: enable port 8080 for apache2
  lineinfile:
    destfile: '/etc/apache2/ports.conf'
    state: present
    regexp: '^Listen\s+8080$'
    line: 'Listen 8080'
  notify:
  - restart apache2

- name: enable apache2 mod_wsgi
  apache2_module:
    name: wsgi
    state: present
  notify:
  - restart apache2

- name: add apache2 stats site
  copy:
    src: apache2-stats.conf
    dest: /etc/apache2/sites-enabled/apache2-stats.conf
  notify:
  - restart apache2
