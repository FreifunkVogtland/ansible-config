# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2017-2020, Sven Eckelmann <sven@narfation.org>
---
- name: add apt https support
  apt:
    pkg:
    - apt-transport-https
    state: present

- name: enable grafana apt key
  apt_key:
    data: "{{ lookup('file', 'grafana.asc') }}"
    state: present 
    keyring: /etc/apt/trusted.gpg.d/grafana.gpg

- name: add grafana apt sources
  copy:
    src: grafana.list
    dest: /etc/apt/sources.list.d/grafana.list
  notify: update apt-cache

- name: add grafana apt preferences
  copy:
    src: grafana.pref
    dest: /etc/apt/preferences.d/grafana.pref
  notify: update apt-cache

- meta: flush_handlers

- name: install grafana dependencies
  apt:
    pkg:
    - nginx-light
    - grafana
    - influxdb
    - sqlite3
    state: present

- name: add grafana dashboard provisioning configuration
  copy:
    src: ffv.yaml
    dest: /etc/grafana/provisioning/dashboards/ffv.yaml
    owner: root
    group: grafana
    mode: 0640
  notify: restart grafana-server

- name: add grafana configuration
  copy:
    src: grafana.ini
    dest: /etc/grafana/grafana.ini
    owner: root
    group: grafana
    mode: 0640
  notify: restart grafana-server

- name: add influxdb config
  copy:
    src: influxdb.conf
    dest: /etc/influxdb/influxdb.conf
  notify:
  - restart influxdb

- name: add nginx stats site
  copy:
    src: stats
    dest: /etc/nginx/sites-enabled/stats
  notify:
  - restart nginx

# ensure that all services run with the correct config before continuing
- meta: flush_handlers
