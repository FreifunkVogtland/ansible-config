---
- name: install server-statistics dependencies
  apt: pkg={{ item }} state=present
  with_items:
  - vnstati
  - php-fpm

- name: drop libapache2-mod-php
  apt: pkg={{ item }} state=absent
  with_items:
  - libapache2-mod-php7.0

- name: enable event mpm
  apache2_module:
    name: mpm_event
    state: present
  notify:
  - restart apache2

- name: enable apache2 http2
  apache2_module:
    name: http2
    state: present
  notify:
  - restart apache2

- name: enable apache2 http2
  apache2_module:
    name: proxy_fcgi
    state: present
  notify:
  - restart apache2

- name: enable apache2 http2
  apache2_module:
    name: setenvif
    state: present
  notify:
  - restart apache2

- name: Activate configuration
  command:
    a2enconf php7.0-fpm.conf
    creates=/etc/apache2/conf-enabled/php7.0-fpm.conf
  sudo: yes
  notify: apache-reload

- name: Install server statistics
  git:
    repo: 'https://github.com/FreifunkVogtland/ffc-server-statistics.git'
    dest: /var/www/vnstat

- name: remove old webserver index
  file:
    path: /var/www/html/index.html
    state: absent

- name: install server statistics index
  file:
    src: /var/www/vnstat/index.php
    dest: /var/www/html/index.php
    state: link

- name: install server statistics config
  template:
    src: stats.conf.j2
    dest: /var/www/vnstat/stats.conf

- name: install server statistics index
  file:
    src: /var/www/vnstat/stats.conf
    dest: /var/www/html/stats.conf
    state: link

- name: install server-statistics systemd unit file
  copy:
    src: server-statistics.service
    dest: /etc/systemd/system/server-statistics.service

- name: install server-statistics systemd timer file
  copy:
    src: server-statistics.timer
    dest: /etc/systemd/system/server-statistics.timer

- name: start server-statistics
  systemd:
    name: server-statistics.timer
    state: started
    daemon_reload: yes
    enabled: yes

    
# TODO certbot
